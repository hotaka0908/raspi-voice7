<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Voice Messenger - raspi-voice6</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            height: 100%;
            overflow: hidden;
            color: #333;
            position: fixed;
            width: 100%;
        }

        /* „Éò„ÉÉ„ÉÄ„Éº */
        .header {
            background: #4ade80;
            color: white;
            padding: 15px 20px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header h1 {
            font-size: 1.2rem;
            font-weight: 600;
            flex: 1;
        }

        .header .back-btn {
            display: none;
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
        }

        .header .back-btn.visible {
            display: block;
        }

        .header .chat-partner {
            display: none;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .header .chat-partner.visible {
            display: flex;
        }

        .header .chat-partner .avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .header .chat-partner .name {
            font-size: 1.1rem;
            font-weight: 600;
        }

        /* „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„Éä */
        .container {
            padding-top: 60px;
            height: 100%;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: none;
        }

        /* „Éà„Éº„ÇØ„É™„Çπ„ÉàÁîªÈù¢ */
        .talk-list-view {
            display: block;
            padding-bottom: 20px;
        }

        .talk-list-view.hidden {
            display: none;
        }

        .talk-item {
            background: white;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
        }

        .talk-item:active {
            background: #f0f0f0;
        }

        .talk-item .avatar {
            width: 55px;
            height: 55px;
            border-radius: 50%;
            background: linear-gradient(145deg, #4ade80, #22c55e);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            flex-shrink: 0;
        }

        .talk-item .info {
            flex: 1;
            min-width: 0;
        }

        .talk-item .top-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .talk-item .name {
            font-weight: 600;
            font-size: 1rem;
        }

        .talk-item .time {
            font-size: 0.75rem;
            color: #999;
            flex-shrink: 0;
        }

        .talk-item .preview {
            font-size: 0.9rem;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .talk-item .badge {
            background: #4ade80;
            color: white;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 3px 8px;
            border-radius: 10px;
            margin-left: 10px;
            flex-shrink: 0;
        }

        .empty-talks {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        /* „ÉÅ„É£„ÉÉ„ÉàÁîªÈù¢ */
        .chat-view {
            display: none;
            flex-direction: column;
            position: fixed;
            top: 60px;
            left: 0;
            right: 0;
            bottom: 0;
        }

        .chat-view.visible {
            display: flex;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            padding-bottom: 15px;
            background: #e5ddd5;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23d4ccc4' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            display: flex;
            flex-direction: column;
            overscroll-behavior: none;
            -webkit-overflow-scrolling: touch;
        }

        .chat-date-divider {
            text-align: center;
            margin: 15px 0;
        }

        .chat-date-divider span {
            background: rgba(0,0,0,0.2);
            color: white;
            font-size: 0.75rem;
            padding: 5px 12px;
            border-radius: 8px;
        }

        .message-bubble {
            max-width: 85%;
            margin-bottom: 15px;
            display: flex;
            gap: 8px;
        }

        .message-bubble.received {
            align-self: flex-start;
            flex-direction: row;
        }

        .message-bubble.sent {
            align-self: flex-end;
            flex-direction: row;
            justify-content: flex-end;
        }

        .message-bubble.sent .content {
            align-items: flex-end;
        }

        .message-bubble .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
            align-self: flex-end;
        }

        .message-bubble.received .avatar {
            background: linear-gradient(145deg, #4ade80, #22c55e);
        }

        .message-bubble .content {
            display: flex;
            flex-direction: column;
        }

        .message-bubble .sender-name {
            font-size: 0.75rem;
            color: #666;
            margin-bottom: 4px;
            font-weight: 500;
        }

        .message-bubble .bubble {
            padding: 10px 14px;
            border-radius: 18px;
            position: relative;
            cursor: pointer;
            transition: background 0.2s;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .message-bubble.received .bubble {
            background: white;
            border-bottom-left-radius: 4px;
        }

        .message-bubble.sent .bubble {
            background: #dcf8c6;
            border-bottom-right-radius: 4px;
        }

        .message-bubble .bubble:active {
            opacity: 0.8;
        }

        .message-bubble .text {
            font-size: 0.95rem;
            line-height: 1.4;
            word-break: break-word;
        }

        .message-bubble .bubble.playing {
            background: rgba(74, 222, 128, 0.2) !important;
        }

        .message-bubble .meta {
            font-size: 0.7rem;
            color: #999;
            margin-top: 4px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .message-bubble.sent .meta {
            justify-content: flex-end;
        }

        .message-bubble .played-icon {
            color: #4ade80;
        }

        /* ÂÜôÁúü„É°„ÉÉ„Çª„Éº„Ç∏ */
        .message-bubble .photo-bubble {
            padding: 4px;
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
        }

        .message-bubble .photo-bubble img {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            display: block;
        }

        .message-bubble.received .photo-bubble {
            background: white;
        }

        .message-bubble.sent .photo-bubble {
            background: #dcf8c6;
        }

        /* „Éï„É´„Çπ„ÇØ„É™„Éº„É≥ÁîªÂÉèË°®Á§∫ */
        .photo-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 300;
        }

        .photo-modal.active {
            display: flex;
        }

        .photo-modal img {
            max-width: 95%;
            max-height: 95%;
            object-fit: contain;
        }

        .photo-modal .close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            font-size: 2rem;
            background: none;
            border: none;
            cursor: pointer;
        }

        /* Èå≤Èü≥„Éê„Éº */
        .record-bar {
            background: white;
            padding: 10px 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            border-top: 1px solid #ddd;
            flex-shrink: 0;
        }

        .record-bar .record-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        .record-bar .record-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 3px solid #333;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
            position: relative;
        }

        .record-bar .record-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 28px;
            height: 28px;
            background: #ef4444;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .record-bar .record-btn:active::before,
        .record-bar .record-btn.recording::before {
            border-radius: 4px;
            width: 20px;
            height: 20px;
        }

        .record-bar .record-btn.recording {
            animation: pulse-record 1s infinite;
        }

        @keyframes pulse-record {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            50% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); }
        }

        .record-bar .record-hint {
            position: absolute;
            left: 60px;
            white-space: nowrap;
            font-size: 0.85rem;
            color: #999;
        }


        /* „Ç™„Éº„Éê„Éº„É¨„Ç§ */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 20px;
            z-index: 200;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255,255,255,0.2);
            border-top-color: #4ade80;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .overlay p {
            color: white;
            font-size: 1rem;
        }

        /* Ë©≥Á¥∞ÊÉÖÂ†±„Éú„Çø„É≥ */
        .detail-btn {
            color: white;
            font-size: 1.3rem;
            text-decoration: none;
            padding: 5px 8px;
        }

        /* „Éì„Éá„Ç™ÈÄöË©±„Éú„Çø„É≥ */
        .videocall-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px 10px;
        }

        /* „Éì„Éá„Ç™ÈÄöË©±„Ç™„Éº„Éê„Éº„É¨„Ç§ */
        .videocall-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #1a1a1a;
            display: none;
            flex-direction: column;
            z-index: 500;
        }

        .videocall-overlay.active {
            display: flex;
        }

        .videocall-overlay .video-container {
            flex: 1;
            position: relative;
            background: #000;
        }

        .videocall-overlay #remoteVideo {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .videocall-controls {
            position: absolute;
            bottom: 30px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            gap: 20px;
            padding: 0 20px;
        }

        .videocall-controls button {
            width: 55px;
            height: 55px;
            border-radius: 50%;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            transition: all 0.2s;
        }

        .videocall-controls button:active {
            transform: scale(0.95);
        }

        .videocall-controls button.off {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.5);
        }

        .videocall-controls button.end-call {
            background: #ef4444;
            color: white;
        }

        .videocall-status {
            position: absolute;
            top: 50px;
            left: 0;
            right: 0;
            text-align: center;
            color: white;
            font-size: 1rem;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
        }

        /* ÁùÄ‰ø°ÈÄöÁü•„Ç™„Éº„Éê„Éº„É¨„Ç§ */
        .incoming-call-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 600;
        }

        .incoming-call-overlay.active {
            display: flex;
        }

        .incoming-call-card {
            background: #2a2a2a;
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            color: white;
            min-width: 280px;
        }

        .incoming-call-card .call-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            animation: pulse-call 1.5s infinite;
        }

        @keyframes pulse-call {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .incoming-call-card .caller-name {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .incoming-call-card .call-type {
            font-size: 0.9rem;
            color: #999;
            margin-bottom: 30px;
        }

        .incoming-call-card .call-actions {
            display: flex;
            justify-content: center;
            gap: 30px;
        }

        .incoming-call-card .call-actions button {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .incoming-call-card .call-actions button:active {
            transform: scale(0.95);
        }

        .incoming-call-card .decline {
            background: #ef4444;
            color: white;
        }

        .incoming-call-card .accept {
            background: #22c55e;
            color: white;
        }
    </style>
</head>
<body>
    <!-- „Éò„ÉÉ„ÉÄ„Éº -->
    <div class="header">
        <button class="back-btn" id="backBtn">‚Üê</button>
        <h1 id="headerTitle">„Éà„Éº„ÇØ</h1>
        <div class="chat-partner" id="chatPartner">
            <span class="name">„É©„Ç∫„Éë„Ç§</span>
        </div>
        <a href="detail.html" class="detail-btn" title="Ë©≥Á¥∞ÊÉÖÂ†±">&#x1F50D;</a>
        <button class="videocall-btn" id="videocallBtn">&#x1F4F9;</button>
    </div>

    <div class="container">
        <!-- „Éà„Éº„ÇØ„É™„Çπ„ÉàÁîªÈù¢ -->
        <div class="talk-list-view" id="talkListView">
            <div id="talkList">
                <div class="empty-talks">„É°„ÉÉ„Çª„Éº„Ç∏„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>
            </div>
        </div>

        <!-- „ÉÅ„É£„ÉÉ„ÉàÁîªÈù¢ -->
        <div class="chat-view" id="chatView">
            <div class="chat-messages" id="chatMessages">
                <!-- „É°„ÉÉ„Çª„Éº„Ç∏„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Çã -->
            </div>
            <div class="record-bar">
                <div class="record-wrapper">
                    <button class="record-btn" id="chatRecordBtn"></button>
                    <span class="record-hint">Êäº„Åó„Å™„Åå„ÇâË©±„Åô</span>
                </div>
            </div>
        </div>
    </div>


    <!-- „Ç™„Éº„Éê„Éº„É¨„Ç§ -->
    <div class="overlay" id="overlay">
        <div class="spinner"></div>
        <p id="overlayText">ÈÄÅ‰ø°‰∏≠...</p>
    </div>

    <!-- ÂÜôÁúü„É¢„Éº„ÉÄ„É´ -->
    <div class="photo-modal" id="photoModal">
        <button class="close-btn" id="closePhotoModal">√ó</button>
        <img id="photoModalImg" src="" alt="ÂÜôÁúü">
    </div>

    <!-- „Éì„Éá„Ç™ÈÄöË©±„Ç™„Éº„Éê„Éº„É¨„Ç§ -->
    <!-- „Çπ„Éû„Éõ„ÅØÊò†ÂÉèÂèó‰ø°„ÅÆ„Åø„ÄÅÈü≥Â£∞„ÅØÂèåÊñπÂêë -->
    <div class="videocall-overlay" id="videocallOverlay">
        <div class="video-container">
            <video id="remoteVideo" autoplay playsinline></video>
            <div class="videocall-status" id="videocallStatus">Êé•Á∂ö‰∏≠...</div>
            <div class="videocall-controls">
                <button id="toggleAudioBtn">üé§</button>
                <button id="endCallBtn" class="end-call">üìû</button>
            </div>
        </div>
    </div>

    <!-- ÁùÄ‰ø°ÈÄöÁü•„Ç™„Éº„Éê„Éº„É¨„Ç§ -->
    <div class="incoming-call-overlay" id="incomingCallOverlay">
        <div class="incoming-call-card">
            <div class="call-icon">üìπ</div>
            <div class="caller-name">„É©„Ç∫„Éë„Ç§</div>
            <div class="call-type">„Éì„Éá„Ç™ÈÄöË©±</div>
            <div class="call-actions">
                <button id="declineCallBtn" class="decline">‚úï</button>
                <button id="acceptCallBtn" class="accept">‚úì</button>
            </div>
        </div>
    </div>

    <script src="videocall.js"></script>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, push, set, onValue, update, query, orderByChild, limitToLast } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';
        import firebaseConfig from './firebase-config.js';

        // ÂàùÊúüÂåñ
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const storage = getStorage(app);

        // FirebaseÈñ¢Êï∞„Çí„Ç∞„É≠„Éº„Éê„É´„Å´ÂÖ¨ÈñãÔºàvideocall.jsÁî®Ôºâ
        window.firebaseFunctions = { ref, push, set, onValue, update };

        const DEVICE_ID = 'phone';

        // DOMË¶ÅÁ¥†
        const backBtn = document.getElementById('backBtn');
        const headerTitle = document.getElementById('headerTitle');
        const chatPartner = document.getElementById('chatPartner');
        const talkListView = document.getElementById('talkListView');
        const talkList = document.getElementById('talkList');
        const chatView = document.getElementById('chatView');
        const chatMessages = document.getElementById('chatMessages');
        const chatRecordBtn = document.getElementById('chatRecordBtn');
        const overlay = document.getElementById('overlay');
        const overlayText = document.getElementById('overlayText');
        const photoModal = document.getElementById('photoModal');
        const photoModalImg = document.getElementById('photoModalImg');
        const closePhotoModal = document.getElementById('closePhotoModal');

        // Áä∂ÊÖã
        let allMessages = [];
        let currentView = 'list'; // 'list' or 'chat'
        let currentChatPartner = null;
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        let currentAudio = null;
        let knownMessageIds = new Set();
        let isFirstLoad = true;

        // ÈÄöÁü•Èü≥
        function playNotificationSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                oscillator.frequency.value = 880;
                oscillator.type = 'sine';

                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);

                setTimeout(() => {
                    const osc2 = audioContext.createOscillator();
                    const gain2 = audioContext.createGain();
                    osc2.connect(gain2);
                    gain2.connect(audioContext.destination);
                    osc2.frequency.value = 1320;
                    osc2.type = 'sine';
                    gain2.gain.setValueAtTime(0.2, audioContext.currentTime);
                    gain2.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                    osc2.start(audioContext.currentTime);
                    osc2.stop(audioContext.currentTime + 0.3);
                }, 150);
            } catch (e) {
                console.log('ÈÄöÁü•Èü≥„ÅÆÂÜçÁîü„Å´Â§±Êïó:', e);
            }
        }

        // ÁîªÈù¢Âàá„ÇäÊõø„Åà
        function showListView() {
            currentView = 'list';
            talkListView.classList.remove('hidden');
            chatView.classList.remove('visible');
            backBtn.classList.remove('visible');
            headerTitle.style.display = 'block';
            chatPartner.classList.remove('visible');
        }

        function showChatView(partnerId, partnerName) {
            currentView = 'chat';
            currentChatPartner = partnerId;
            talkListView.classList.add('hidden');
            chatView.classList.add('visible');
            backBtn.classList.add('visible');
            headerTitle.style.display = 'none';
            chatPartner.classList.add('visible');
            chatPartner.querySelector('.name').textContent = partnerName;
            renderChatMessages();

            // Á¢∫ÂÆü„Å´ÊúÄ‰∏ãÈÉ®„Å´„Çπ„ÇØ„É≠„Éº„É´ÔºàÈÅÖÂª∂ÂÆüË°åÔºâ
            setTimeout(() => {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 100);

            // Êú™Ë™≠„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÊó¢Ë™≠„Å´„Åô„Çã
            markMessagesAsRead(partnerId);
        }

        // „Éà„Éº„ÇØ„É™„Çπ„Éà„Çí„É¨„É≥„ÉÄ„É™„É≥„Ç∞
        function renderTalkList() {
            // Áõ∏Êâã„Åî„Å®„Å´„Ç∞„É´„Éº„ÉóÂåñ
            const partners = {};
            allMessages.forEach(msg => {
                const partner = msg.from === DEVICE_ID ? 'raspi' : msg.from;
                if (!partners[partner]) {
                    partners[partner] = {
                        id: partner,
                        name: partner === 'raspi' ? '„É©„Ç∫„Éë„Ç§' : partner,
                        messages: [],
                        unreadCount: 0,
                        lastMessage: null,
                        lastTime: 0
                    };
                }
                partners[partner].messages.push(msg);
                if (msg.from !== DEVICE_ID && !msg.played) {
                    partners[partner].unreadCount++;
                }
                if (msg.timestamp > partners[partner].lastTime) {
                    partners[partner].lastTime = msg.timestamp;
                    partners[partner].lastMessage = msg;
                }
            });

            const partnerList = Object.values(partners).sort((a, b) => b.lastTime - a.lastTime);

            if (partnerList.length === 0) {
                talkList.innerHTML = '<div class="empty-talks">„É°„ÉÉ„Çª„Éº„Ç∏„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
                return;
            }

            talkList.innerHTML = partnerList.map(partner => {
                const lastMsg = partner.lastMessage;
                const isPhoto = lastMsg?.type === 'photo' || lastMsg?.photo_url;
                const preview = lastMsg?.text || (isPhoto ? 'üì∑ ÂÜôÁúü' : 'üé§ Èü≥Â£∞„É°„ÉÉ„Çª„Éº„Ç∏');
                const time = formatTimeShort(partner.lastTime);
                const badge = partner.unreadCount > 0 ? `<span class="badge">${partner.unreadCount}</span>` : '';

                return `
                    <div class="talk-item" data-partner-id="${partner.id}" data-partner-name="${partner.name}">
                        <div class="avatar">ü§ñ</div>
                        <div class="info">
                            <div class="top-row">
                                <span class="name">${partner.name}</span>
                                <span class="time">${time}</span>
                            </div>
                            <div class="preview">${preview}</div>
                        </div>
                        ${badge}
                    </div>
                `;
            }).join('');

            // „ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà
            document.querySelectorAll('.talk-item').forEach(item => {
                item.addEventListener('click', () => {
                    const partnerId = item.dataset.partnerId;
                    const partnerName = item.dataset.partnerName;
                    showChatView(partnerId, partnerName);
                });
            });
        }

        // „ÉÅ„É£„ÉÉ„Éà„É°„ÉÉ„Çª„Éº„Ç∏„Çí„É¨„É≥„ÉÄ„É™„É≥„Ç∞
        function renderChatMessages() {
            if (!currentChatPartner) return;

            // ÁèæÂú®„ÅÆ„Éë„Éº„Éà„Éä„Éº„Å®„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„Çí„Éï„Ç£„É´„Çø
            const messages = allMessages.filter(msg => {
                return msg.from === currentChatPartner ||
                       (msg.from === DEVICE_ID && currentChatPartner === 'raspi');
            }).sort((a, b) => a.timestamp - b.timestamp);

            if (messages.length === 0) {
                chatMessages.innerHTML = '<div style="text-align:center;padding:40px;color:#999;">„É°„ÉÉ„Çª„Éº„Ç∏„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
                return;
            }

            let html = '';
            let lastDate = null;

            messages.forEach(msg => {
                const date = new Date(msg.timestamp).toDateString();
                if (date !== lastDate) {
                    html += `
                        <div class="chat-date-divider">
                            <span>${formatDateHeader(msg.timestamp)}</span>
                        </div>
                    `;
                    lastDate = date;
                }

                const isSent = msg.from === DEVICE_ID;
                const isPhoto = msg.type === 'photo' || msg.photo_url;
                const hasText = msg.text && msg.text.trim();
                const time = formatTimeShort(msg.timestamp);
                const playedIcon = isSent && msg.played ? '<span class="played-icon">‚úì‚úì</span>' : '';
                const senderName = msg.from === 'raspi' ? '„É©„Ç∫„Éë„Ç§' : msg.from;

                let bubbleContent;
                if (isPhoto) {
                    // ÂÜôÁúü„É°„ÉÉ„Çª„Éº„Ç∏
                    const photoUrl = msg.photo_url;
                    bubbleContent = `
                        <div class="photo-bubble" data-photo-url="${photoUrl}" data-id="${msg.id}">
                            <img src="${photoUrl}" alt="ÂÜôÁúü" loading="lazy">
                        </div>
                        ${hasText ? `<div class="bubble"><div class="text">${msg.text}</div></div>` : ''}
                    `;
                } else {
                    // Èü≥Â£∞„É°„ÉÉ„Çª„Éº„Ç∏
                    const displayText = hasText ? msg.text : 'üé§ Èü≥Â£∞„É°„ÉÉ„Çª„Éº„Ç∏';
                    bubbleContent = `
                        <div class="bubble" data-url="${msg.audio_url}" data-id="${msg.id}">
                            <div class="text">${displayText}</div>
                        </div>
                    `;
                }

                html += `
                    <div class="message-bubble ${isSent ? 'sent' : 'received'}">
                        ${!isSent ? '<div class="avatar">ü§ñ</div>' : ''}
                        <div class="content">
                            ${!isSent ? `<div class="sender-name">${senderName}</div>` : ''}
                            ${bubbleContent}
                            <div class="meta">
                                <span>${time}</span>
                                ${playedIcon}
                            </div>
                        </div>
                    </div>
                `;
            });

            chatMessages.innerHTML = html;

            // „Éê„Éñ„É´„ÇØ„É™„ÉÉ„ÇØ„ÅßÈü≥Â£∞ÂÜçÁîü
            document.querySelectorAll('.message-bubble .bubble[data-url]').forEach(bubble => {
                bubble.addEventListener('click', () => playAudioFromBubble(bubble));
            });

            // ÂÜôÁúü„ÇØ„É™„ÉÉ„ÇØ„Åß„É¢„Éº„ÉÄ„É´Ë°®Á§∫
            document.querySelectorAll('.message-bubble .photo-bubble').forEach(photoBubble => {
                photoBubble.addEventListener('click', () => openPhotoModal(photoBubble));
            });

            // „Çπ„ÇØ„É≠„Éº„É´„Çí‰∏ÄÁï™‰∏ã„Å∏ÔºàË§áÊï∞ÂõûÂÆüË°å„ÅßÁ¢∫ÂÆü„Å´Ôºâ
            chatMessages.scrollTop = chatMessages.scrollHeight;
            requestAnimationFrame(() => {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            });
            setTimeout(() => {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 50);
        }

        // ÂÜôÁúü„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
        function openPhotoModal(photoBubble) {
            const url = photoBubble.dataset.photoUrl;
            const id = photoBubble.dataset.id;

            photoModalImg.src = url;
            photoModal.classList.add('active');

            // ÂÜçÁîüÊ∏à„Åø„Å´„Éû„Éº„ÇØ
            const msgRef = ref(db, `messages/${id}`);
            update(msgRef, { played: true });
        }

        // ÂÜôÁúü„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        function closePhotoModalHandler() {
            photoModal.classList.remove('active');
            photoModalImg.src = '';
        }

        // Èü≥Â£∞ÂÜçÁîü
        function playAudioFromBubble(bubble) {
            const url = bubble.dataset.url;
            const id = bubble.dataset.id;

            // Êó¢„Å´ÂÜçÁîü‰∏≠„Å™„ÇâÂÅúÊ≠¢
            if (currentAudio) {
                currentAudio.pause();
                document.querySelectorAll('.bubble.playing').forEach(b => {
                    b.classList.remove('playing');
                });
            }

            if (bubble.classList.contains('playing')) {
                currentAudio = null;
                return;
            }

            bubble.classList.add('playing');

            currentAudio = new Audio(url);
            currentAudio.play();

            currentAudio.onended = () => {
                bubble.classList.remove('playing');
                currentAudio = null;
            };

            // ÂÜçÁîüÊ∏à„Åø„Å´„Éû„Éº„ÇØ
            const msgRef = ref(db, `messages/${id}`);
            update(msgRef, { played: true });
        }

        // „É°„ÉÉ„Çª„Éº„Ç∏„ÇíÊó¢Ë™≠„Å´„Éû„Éº„ÇØ
        function markMessagesAsRead(partnerId) {
            allMessages.forEach(msg => {
                if (msg.from === partnerId && !msg.played) {
                    const msgRef = ref(db, `messages/${msg.id}`);
                    update(msgRef, { played: true });
                }
            });
        }

        // Èü≥Â£∞Ë™çË≠òÔºàWeb Speech APIÔºâ
        let recognition = null;
        let recognizedText = '';

        function initSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                console.log('Web Speech APIÈùûÂØæÂøú');
                return null;
            }

            const recog = new SpeechRecognition();
            recog.lang = 'ja-JP';
            recog.continuous = true;
            recog.interimResults = true;

            recog.onresult = (event) => {
                let finalText = '';
                let interimText = '';

                for (let i = 0; i < event.results.length; i++) {
                    const result = event.results[i];
                    if (result.isFinal) {
                        finalText += result[0].transcript;
                    } else {
                        interimText += result[0].transcript;
                    }
                }

                recognizedText = finalText || interimText;
                console.log('Ë™çË≠ò‰∏≠:', recognizedText);
            };

            recog.onerror = (event) => {
                console.log('Èü≥Â£∞Ë™çË≠ò„Ç®„É©„Éº:', event.error);
            };

            return recog;
        }

        // Èå≤Èü≥Ê©üËÉΩ
        async function startRecording(btn) {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
                audioChunks = [];
                recognizedText = '';

                // Èü≥Â£∞Ë™çË≠ò„ÇíÈñãÂßã
                recognition = initSpeechRecognition();
                if (recognition) {
                    try {
                        recognition.start();
                    } catch (e) {
                        console.log('Èü≥Â£∞Ë™çË≠òÈñãÂßã„Ç®„É©„Éº:', e);
                    }
                }

                mediaRecorder.ondataavailable = (e) => {
                    audioChunks.push(e.data);
                };

                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    stream.getTracks().forEach(track => track.stop());

                    // Èü≥Â£∞Ë™çË≠ò„ÇíÂÅúÊ≠¢
                    if (recognition) {
                        try {
                            recognition.stop();
                        } catch (e) {
                            console.log('Èü≥Â£∞Ë™çË≠òÂÅúÊ≠¢„Ç®„É©„Éº:', e);
                        }
                    }

                    // Â∞ë„ÅóÂæÖ„Å£„Å¶„Åã„ÇâÈÄÅ‰ø°ÔºàË™çË≠òÁµêÊûú„ÅåÁ¢∫ÂÆö„Åô„Çã„ÅÆ„ÇíÂæÖ„Å§Ôºâ
                    setTimeout(async () => {
                        await sendVoiceMessage(audioBlob, recognizedText);
                    }, 300);
                };

                mediaRecorder.start();
                isRecording = true;
                btn.classList.add('recording');
            } catch (err) {
                console.error('Èå≤Èü≥„Ç®„É©„Éº:', err);
                alert('„Éû„Ç§„ÇØ„Å∏„ÅÆ„Ç¢„ÇØ„Çª„Çπ„ÇíË®±ÂèØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
            }
        }

        function stopRecording(btn) {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                btn.classList.remove('recording');
            }
        }

        // Èü≥Â£∞ÈÄÅ‰ø°
        async function sendVoiceMessage(audioBlob, text = '') {
            showOverlay('ÈÄÅ‰ø°‰∏≠...');

            try {
                const timestamp = Date.now();
                const filename = `${DEVICE_ID}_${timestamp}.webm`;

                const audioRef = storageRef(storage, `audio/${filename}`);
                await uploadBytes(audioRef, audioBlob);
                const audioUrl = await getDownloadURL(audioRef);

                const messageData = {
                    from: DEVICE_ID,
                    audio_url: audioUrl,
                    filename: filename,
                    timestamp: timestamp,
                    played: false
                };

                // „ÉÜ„Ç≠„Çπ„Éà„Åå„ÅÇ„Çå„Å∞ËøΩÂä†
                if (text && text.trim()) {
                    messageData.text = text.trim();
                }

                const messagesRef = ref(db, 'messages');
                await push(messagesRef, messageData);

                hideOverlay();
            } catch (err) {
                console.error('ÈÄÅ‰ø°„Ç®„É©„Éº:', err);
                hideOverlay();
                alert('ÈÄÅ‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        }

        // „É°„ÉÉ„Çª„Éº„Ç∏Áõ£Ë¶ñ
        function listenForMessages() {
            const messagesRef = query(
                ref(db, 'messages'),
                orderByChild('timestamp'),
                limitToLast(50)
            );

            onValue(messagesRef, (snapshot) => {
                const data = snapshot.val();
                if (!data) {
                    allMessages = [];
                    renderTalkList();
                    if (currentView === 'chat') renderChatMessages();
                    isFirstLoad = false;
                    return;
                }

                const messages = Object.entries(data)
                    .map(([id, msg]) => ({ id, ...msg }))
                    .sort((a, b) => b.timestamp - a.timestamp);

                // Êñ∞ÁùÄ„ÉÅ„Çß„ÉÉ„ÇØÔºàÈÄöÁü•Èü≥Ôºâ
                let hasNewMessage = false;
                messages.forEach(msg => {
                    if (!knownMessageIds.has(msg.id)) {
                        knownMessageIds.add(msg.id);
                        if (!isFirstLoad && msg.from !== DEVICE_ID && !msg.played) {
                            hasNewMessage = true;
                        }
                    }
                });

                if (hasNewMessage) {
                    playNotificationSound();
                }

                isFirstLoad = false;
                allMessages = messages;

                if (currentView === 'list') {
                    renderTalkList();
                } else {
                    renderChatMessages();
                    renderTalkList(); // „Éê„ÉÉ„Ç∏Êõ¥Êñ∞Áî®
                }
            });
        }

        // ÊôÇÈñì„Éï„Ç©„Éº„Éû„ÉÉ„Éà
        function formatTimeShort(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const isToday = date.toDateString() === now.toDateString();

            if (isToday) {
                return date.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
            } else {
                return date.toLocaleDateString('ja-JP', { month: 'numeric', day: 'numeric' });
            }
        }

        function formatDateHeader(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const isToday = date.toDateString() === now.toDateString();
            const isYesterday = new Date(now - 86400000).toDateString() === date.toDateString();

            if (isToday) return '‰ªäÊó•';
            if (isYesterday) return 'Êò®Êó•';
            return date.toLocaleDateString('ja-JP', { year: 'numeric', month: 'long', day: 'numeric' });
        }

        // „Ç™„Éº„Éê„Éº„É¨„Ç§
        function showOverlay(text) {
            overlayText.textContent = text;
            overlay.classList.add('active');
        }

        function hideOverlay() {
            overlay.classList.remove('active');
        }

        // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
        backBtn.addEventListener('click', showListView);

        // ÂÜôÁúü„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        closePhotoModal.addEventListener('click', closePhotoModalHandler);
        photoModal.addEventListener('click', (e) => {
            if (e.target === photoModal) closePhotoModalHandler();
        });

        // „ÉÅ„É£„ÉÉ„ÉàÁîªÈù¢„ÅÆÈå≤Èü≥„Éú„Çø„É≥
        chatRecordBtn.addEventListener('mousedown', () => startRecording(chatRecordBtn));
        chatRecordBtn.addEventListener('mouseup', () => stopRecording(chatRecordBtn));
        chatRecordBtn.addEventListener('mouseleave', () => stopRecording(chatRecordBtn));
        chatRecordBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            startRecording(chatRecordBtn);
        });
        chatRecordBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            stopRecording(chatRecordBtn);
        });

        // ========================================
        // „Éì„Éá„Ç™ÈÄöË©±Ê©üËÉΩ
        // ========================================
        const videocallBtn = document.getElementById('videocallBtn');
        const videocallOverlay = document.getElementById('videocallOverlay');
        const remoteVideo = document.getElementById('remoteVideo');
        const videocallStatus = document.getElementById('videocallStatus');
        const toggleAudioBtn = document.getElementById('toggleAudioBtn');
        const endCallBtn = document.getElementById('endCallBtn');
        const incomingCallOverlay = document.getElementById('incomingCallOverlay');
        const acceptCallBtn = document.getElementById('acceptCallBtn');
        const declineCallBtn = document.getElementById('declineCallBtn');

        let videoCallManager = null;
        let pendingIncomingCall = null;
        let audioEnabled = true;

        // ÁùÄ‰ø°Èü≥
        let ringtoneInterval = null;
        function playRingtone() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                oscillator.frequency.value = 440;
                oscillator.type = 'sine';

                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.4);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.4);
            } catch (e) {
                console.log('ÁùÄ‰ø°Èü≥„Ç®„É©„Éº:', e);
            }
        }

        function startRingtone() {
            playRingtone();
            ringtoneInterval = setInterval(playRingtone, 1500);
        }

        function stopRingtone() {
            if (ringtoneInterval) {
                clearInterval(ringtoneInterval);
                ringtoneInterval = null;
            }
        }

        // VideoCallManagerÂàùÊúüÂåñ
        function initVideoCall() {
            if (!window.VideoCallManager) {
                console.log('VideoCallManager not loaded');
                return;
            }

            videoCallManager = new window.VideoCallManager(db);

            // ÁùÄ‰ø°„Ç≥„Éº„É´„Éê„ÉÉ„ÇØ
            videoCallManager.onIncomingCall = (sessionId, session) => {
                console.log('ÁùÄ‰ø°:', sessionId);
                pendingIncomingCall = { sessionId, session };
                incomingCallOverlay.classList.add('active');
                startRingtone();
            };

            // „É™„É¢„Éº„Éà„Çπ„Éà„É™„Éº„É†„Ç≥„Éº„É´„Éê„ÉÉ„ÇØÔºà„É©„Ç∫„Éë„Ç§„Åã„Çâ„ÅÆÊò†ÂÉèÔºâ
            videoCallManager.onRemoteStream = (stream) => {
                remoteVideo.srcObject = stream;
            };

            // Êé•Á∂öÁä∂ÊÖãÂ§âÊõ¥„Ç≥„Éº„É´„Éê„ÉÉ„ÇØ
            videoCallManager.onConnectionStateChange = (state) => {
                switch (state) {
                    case 'connecting':
                        videocallStatus.textContent = 'Êé•Á∂ö‰∏≠...';
                        break;
                    case 'connected':
                        videocallStatus.textContent = 'ÈÄöË©±‰∏≠';
                        setTimeout(() => {
                            videocallStatus.style.display = 'none';
                        }, 2000);
                        break;
                    case 'disconnected':
                        videocallStatus.textContent = 'ÂàáÊñ≠„Åï„Çå„Åæ„Åó„Åü';
                        break;
                    case 'failed':
                        videocallStatus.textContent = 'Êé•Á∂öÂ§±Êïó';
                        break;
                }
            };

            // ÈÄöË©±ÁµÇ‰∫Ü„Ç≥„Éº„É´„Éê„ÉÉ„ÇØ
            videoCallManager.onCallEnded = () => {
                hideVideoCall();
            };

            // „Ç∑„Ç∞„Éä„É™„É≥„Ç∞Áõ£Ë¶ñÈñãÂßã
            videoCallManager.startListening();
        }

        // „Éì„Éá„Ç™ÈÄöË©±ÁîªÈù¢Ë°®Á§∫
        function showVideoCall() {
            videocallOverlay.classList.add('active');
            videocallStatus.style.display = 'block';
            videocallStatus.textContent = 'Êé•Á∂ö‰∏≠...';
            audioEnabled = true;
            toggleAudioBtn.classList.remove('off');
        }

        // „Éì„Éá„Ç™ÈÄöË©±ÁîªÈù¢ÈùûË°®Á§∫
        function hideVideoCall() {
            videocallOverlay.classList.remove('active');
            remoteVideo.srcObject = null;
        }

        // Áô∫‰ø°„Éú„Çø„É≥
        videocallBtn.addEventListener('click', async () => {
            console.log('videocallBtn clicked, videoCallManager:', videoCallManager);
            if (!videoCallManager) {
                alert('„Éì„Éá„Ç™ÈÄöË©±„ÅÆÂàùÊúüÂåñ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇVideoCallManager: ' + (window.VideoCallManager ? 'loaded' : 'not loaded'));
                return;
            }

            try {
                showVideoCall();
                await videoCallManager.startCall();
            } catch (error) {
                console.error('Áô∫‰ø°„Ç®„É©„Éº:', error);
                alert('Áô∫‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
                hideVideoCall();
            }
        });

        // ÁùÄ‰ø°ÂøúÁ≠î„Éú„Çø„É≥
        acceptCallBtn.addEventListener('click', async () => {
            if (!pendingIncomingCall || !videoCallManager) return;

            stopRingtone();
            incomingCallOverlay.classList.remove('active');

            try {
                showVideoCall();
                await videoCallManager.acceptCall(
                    pendingIncomingCall.sessionId,
                    pendingIncomingCall.session
                );
            } catch (error) {
                console.error('ÂøúÁ≠î„Ç®„É©„Éº:', error);
                hideVideoCall();
            }

            pendingIncomingCall = null;
        });

        // ÁùÄ‰ø°ÊãíÂê¶„Éú„Çø„É≥
        declineCallBtn.addEventListener('click', async () => {
            if (!pendingIncomingCall || !videoCallManager) return;

            stopRingtone();
            incomingCallOverlay.classList.remove('active');
            await videoCallManager.rejectCall(pendingIncomingCall.sessionId);
            pendingIncomingCall = null;
        });

        // ÈÄöË©±ÁµÇ‰∫Ü„Éú„Çø„É≥
        endCallBtn.addEventListener('click', async () => {
            if (videoCallManager) {
                await videoCallManager.endCall();
            }
            hideVideoCall();
        });

        // „Ç™„Éº„Éá„Ç£„Ç™ON/OFF„Éú„Çø„É≥
        toggleAudioBtn.addEventListener('click', () => {
            if (!videoCallManager) return;
            audioEnabled = videoCallManager.toggleAudio();
            toggleAudioBtn.classList.toggle('off', !audioEnabled);
        });

        // ========================================
        // ‰ΩçÁΩÆÊÉÖÂ†±ÈÄÅ‰ø°Ê©üËÉΩ
        // ========================================
        let lastLocationUpdate = 0;
        const LOCATION_UPDATE_INTERVAL = 60000; // 1ÂàÜ„Åî„Å®„Å´Êõ¥Êñ∞

        // ‰ΩçÁΩÆÊÉÖÂ†±„ÇíFirebase„Å´ÈÄÅ‰ø°
        async function sendLocationToFirebase(position) {
            const now = Date.now();

            // Êõ¥Êñ∞ÈñìÈöî„ÉÅ„Çß„ÉÉ„ÇØÔºà1ÂàÜ‰ª•ÂÜÖ„ÅÆÊõ¥Êñ∞„ÅØ„Çπ„Ç≠„ÉÉ„ÉóÔºâ
            if (now - lastLocationUpdate < LOCATION_UPDATE_INTERVAL) {
                return;
            }

            try {
                const locationRef = ref(db, 'user_location');
                await set(locationRef, {
                    latitude: position.coords.latitude,
                    longitude: position.coords.longitude,
                    accuracy: position.coords.accuracy,
                    timestamp: now,
                    deviceId: DEVICE_ID
                });
                lastLocationUpdate = now;
                console.log('‰ΩçÁΩÆÊÉÖÂ†±„ÇíÈÄÅ‰ø°:', position.coords.latitude, position.coords.longitude);
            } catch (error) {
                console.error('‰ΩçÁΩÆÊÉÖÂ†±ÈÄÅ‰ø°„Ç®„É©„Éº:', error);
            }
        }

        // ‰ΩçÁΩÆÊÉÖÂ†±„ÅÆÂàùÊúüÂåñ
        function initGeolocation() {
            if (!navigator.geolocation) {
                console.log('Geolocation API„Å´ÂØæÂøú„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì');
                return;
            }

            // ‰ΩçÁΩÆÊÉÖÂ†±„ÅÆË®±ÂèØ„ÇíÊ±Ç„ÇÅ„Çã
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    console.log('‰ΩçÁΩÆÊÉÖÂ†±Ë®±ÂèØOK');
                    sendLocationToFirebase(position);

                    // ÁßªÂãïÊôÇ„Å´Âç≥ÊôÇÊõ¥Êñ∞ÔºàwatchPositionÔºâ
                    navigator.geolocation.watchPosition(
                        sendLocationToFirebase,
                        (error) => console.log('‰ΩçÁΩÆÊÉÖÂ†±ÂèñÂæó„Ç®„É©„Éº:', error.message),
                        {
                            enableHighAccuracy: true,
                            timeout: 30000,
                            maximumAge: 60000
                        }
                    );
                },
                (error) => {
                    console.log('‰ΩçÁΩÆÊÉÖÂ†±„ÅåË®±ÂèØ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì:', error.message);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );

            // ÂÆöÊúüÊõ¥Êñ∞Ôºà„Éê„ÉÉ„ÇØ„Ç∞„É©„Ç¶„É≥„Éâ„ÅßwatchPosition„ÅåÂãï„Åã„Å™„ÅÑÂ†¥Âêà„ÅÆ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºâ
            setInterval(() => {
                navigator.geolocation.getCurrentPosition(
                    sendLocationToFirebase,
                    (error) => console.log('‰ΩçÁΩÆÊÉÖÂ†±ÂèñÂæó„Ç®„É©„Éº:', error.message),
                    {
                        enableHighAccuracy: true,
                        timeout: 30000,
                        maximumAge: 60000
                    }
                );
            }, LOCATION_UPDATE_INTERVAL);
        }

        // ÂàùÊúüÂåñ
        listenForMessages();
        initVideoCall();
        initGeolocation();
    </script>
</body>
</html>
